<!DOCTYPE html>
<html>
  <head>
    <title>E2B + LangChain AI Assistant</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
      #chatContainer { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; margin: 20px 0; }
      .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
      .human { background-color: #e6f7ff; text-align: right; }
      .ai { background-color: #f0f0f0; }
      .codeBlock { background-color: #f8f8f8; padding: 10px; border-left: 3px solid #2196F3; font-family: monospace; white-space: pre; overflow-x: auto; }
      #promptInput { width: 80%; padding: 8px; }
      button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
      button:hover { background-color: #45a049; }
      .outputSection { margin-top: 10px; border-left: 3px solid #FFA500; padding-left: 10px; }
    </style>
  </head>
  <body>
    <h1>E2B + LangChain AI Assistant</h1>
    <p>Chat with an AI assistant that can execute Python code and create visualizations.</p>
    
    <div id="chatContainer"></div>
    
    <div>
      <input id="promptInput" type="text" placeholder="Ask a question or request code..." />
      <button id="sendBtn">Send</button>
      <button id="clearBtn">Clear Chat</button>
    </div>
    
    <script>
      let sessionId = Date.now().toString();
      const chatContainer = document.getElementById('chatContainer');
      
      // Add a message to the chat UI
      function addMessage(type, content, enhancedOutput) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}`;
        
        // Add basic content
        msgDiv.textContent = content;
        
        // If there's code in the content, format it
        if (content.includes('```python')) {
          const parts = content.split('```python');
          msgDiv.textContent = parts[0];
          
          parts.slice(1).forEach(part => {
            const codeParts = part.split('```');
            
            if (codeParts[0]) {
              const codeBlock = document.createElement('div');
              codeBlock.className = 'codeBlock';
              codeBlock.textContent = codeParts[0];
              msgDiv.appendChild(codeBlock);
            }
            
            if (codeParts[1]) {
              const textNode = document.createTextNode(codeParts[1]);
              msgDiv.appendChild(textNode);
            }
          });
        }
        
        // Add enhanced output if available
        if (enhancedOutput) {
          if (enhancedOutput.stdout || enhancedOutput.stderr || enhancedOutput.error) {
            const outputSection = document.createElement('div');
            outputSection.className = 'outputSection';
            
            if (enhancedOutput.stdout) {
              const stdoutPre = document.createElement('pre');
              stdoutPre.textContent = enhancedOutput.stdout;
              outputSection.appendChild(stdoutPre);
            }
            
            if (enhancedOutput.stderr) {
              const stderrPre = document.createElement('pre');
              stderrPre.style.color = 'orange';
              stderrPre.textContent = enhancedOutput.stderr;
              outputSection.appendChild(stderrPre);
            }
            
            if (enhancedOutput.error) {
              const errorPre = document.createElement('pre');
              errorPre.style.color = 'red';
              errorPre.textContent = enhancedOutput.error;
              outputSection.appendChild(errorPre);
            }
            
            msgDiv.appendChild(outputSection);
          }
          
          // Handle visualization display if present
          if (enhancedOutput.visualization) {
            // Implementation would render the visualization
            // This could be an image tag for image data or a specialized visualization component
          }
        }
        
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      
      // Send message to the API
      async function sendMessage() {
        const promptInput = document.getElementById('promptInput');
        const prompt = promptInput.value.trim();
        
        if (!prompt) return;
        
        // Add user message to chat
        addMessage('human', prompt);
        promptInput.value = '';
        
        try {
          const response = await fetch('/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, session_id: sessionId })
          });
          
          const data = await response.json();
          
          if (data.error) {
            addMessage('ai', `Error: ${data.error}`);
            return;
          }
          
          // Display only the last AI message instead of all messages
          const aiMessages = data.messages.filter(msg => msg.type === 'ai');
          if (aiMessages.length > 0) {
            const lastAiMessage = aiMessages[aiMessages.length - 1];
            addMessage('ai', lastAiMessage.content, lastAiMessage.enhanced_output);
          }
        } catch (error) {
          addMessage('ai', `Error: ${error.message}`);
        }
      }
      
      // Clear the chat
      async function clearChat() {
        try {
          await fetch('/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
          });
          
          chatContainer.innerHTML = '';
          sessionId = Date.now().toString();
        } catch (error) {
          console.error('Failed to clear chat:', error);
        }
      }
      
      // Event listeners
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('clearBtn').addEventListener('click', clearChat);
      document.getElementById('promptInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    </script>
  </body>
</html> 